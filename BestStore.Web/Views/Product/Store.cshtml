@using BestStore.Application.DTOs.Product
@model ProductListViewModel

@{
    ViewData["Title"] = "Our Store";

    // Helper function for sorting arrows
    HtmlString GetSortArrow(string column)
    {
        if (Model.SortBy != column)
            return new HtmlString("<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='currentColor' class='bi bi-arrow-up text-primary' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5'/></svg>");

        return Model.Ascending
            ? new HtmlString("<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='currentColor' class='bi bi-arrow-down text-primary' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1'/></svg>")
            : new HtmlString("<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='currentColor' class='bi bi-arrow-up text-primary' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5'/></svg>");
    }

    // Helper function to generate sort URL
    string GetSortUrl(string column)
    {
        var newAscending = Model.SortBy == column ? !Model.Ascending : true;

        var queryParams = new ProductQueryParams
        {
            Search = Model.Search,
            CategoryId = Model.CategoryId,
            SortBy = column,
            Ascending = newAscending,
            PageNumber = 1,
            PageSize = Model.PaginatedProducts?.PageSize ?? 12
        };

        return Url.Action("Store", queryParams)!;
    }

    // Helper function for pagination URLs
    string GetPageUrl(int pageNumber)
    {
        return Url.Action("Store", new ProductQueryParams
        {
            Search = Model.Search,
            CategoryId = Model.CategoryId,
            SortBy = Model.SortBy,
            Ascending = Model.Ascending,
            PageNumber = pageNumber,
            PageSize = Model.PaginatedProducts?.PageSize ?? 12
        })!;
    }
}

<div class="container py-4">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-shop me-2" viewBox="0 0 16 16">
                <path d="M2.97 1.35A1 1 0 0 1 3.73 1h8.54a1 1 0 0 1 .76.35l2.609 3.044A1.5 1.5 0 0 1 16 5.37v.255a2.375 2.375 0 0 1-4.25 1.458A2.37 2.37 0 0 1 9.875 8 2.37 2.37 0 0 1 8 7.083 2.37 2.37 0 0 1 6.125 8a2.37 2.37 0 0 1-1.875-.917A2.375 2.375 0 0 1 0 5.625V5.37a1.5 1.5 0 0 1 .361-.976zm1.78 4.275a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 1 0 2.75 0V5.37a.5.5 0 0 0-.12-.325L12.27 2H3.73L1.12 5.045A.5.5 0 0 0 1 5.37v.255a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0M1.5 8.5A.5.5 0 0 1 2 9v6h1v-5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5h6V9a.5.5 0 0 1 1 0v6h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1V9a.5.5 0 0 1 .5-.5M4 15h3v-5H4zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1zm3 0h-2v3h2z" />
            </svg>
            Our Store
        </h1>
        <p class="text-muted lead">Discover the latest products and special offers</p>
    </div>

    <!-- Search and Filter Card -->
    <div class="card shadow-sm mb-5 border-0" style="background-color: #f8f9fa;">
        <div class="card-body p-4">
            <form method="get" asp-action="Store" asp-controller="Product" class="row g-3 align-items-center" id="searchFilterForm">
                <input type="hidden" name="pageNumber" value="1" />
                <input type="hidden" name="sortBy" value="@Model.SortBy" />
                <input type="hidden" name="ascending" value="@Model.Ascending.ToString()" />

                <div class="col-md-4">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#6c757d" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
                            </svg>
                        </span>
                        <input class="form-control border-start-0 py-3"
                               type="search"
                               name="search"
                               value="@Model.Search"
                               placeholder="Search for product or brand..."
                               style="font-size: 1rem;">
                    </div>
                </div>

                <div class="col-md-3">
                    <select class="form-select py-3"
                            asp-for="CategoryId"
                            name="categoryId"
                            onchange="document.getElementById('searchFilterForm').submit()"
                            style="font-size: 1rem;">
                        <option value="">All Categories</option>
                        @foreach (var cat in Model.CategorySelectPairs)
                        {
                            <option value="@cat.CategoryId" selected="@(Model.CategoryId == cat.CategoryId)">@cat.Category</option>
                        }
                    </select>
                </div>

               <div class="col-md-2">
                    <div class="dropdown w-100" id="store-dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100"
                                type="button"
                                data-bs-toggle="dropdown"
                                data-bs-auto-close="true"
                                aria-expanded="false">
                            Sort By @(Model.SortBy == "CreatedAt" ? "Newest" : Model.SortBy)
                        </button>

                        <ul class="dropdown-menu animate__animated animate__fadeIn animate__faster"
                            style="animation-duration: 0.2s;">
                            <li><a class="dropdown-item transition-all" 
                                   href="@GetSortUrl("CreatedAt")"
                                   style="transition: all 0.15s ease-in-out;">Newest</a></li>
                            <li><a class="dropdown-item transition-all" 
                                   href="@GetSortUrl("Name")"
                                   style="transition: all 0.15s ease-in-out;">Name</a></li>
                            <li><a class="dropdown-item transition-all" 
                                   href="@GetSortUrl("Price")"
                                   style="transition: all 0.15s ease-in-out;">Price</a></li>
                            <li><a class="dropdown-item transition-all" 
                                   href="@GetSortUrl("Brand")"
                                   style="transition: all 0.15s ease-in-out;">Brand</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-auto">
                    <a href="@Url.Action("Store", new ProductQueryParams { 
                        Search = Model.Search,
                        CategoryId = Model.CategoryId,
                        SortBy = Model.SortBy,
                        Ascending = !Model.Ascending,
                        PageNumber = Model.PaginatedProducts?.PageNumber ?? 1,
                        PageSize = Model.PaginatedProducts?.PageSize ?? 12
                    })" 
                       class="btn btn-outline-secondary py-3 px-3" 
                       title="@(Model.Ascending ? "Sort Descending" : "Sort Ascending")">
                        @if (Model.Ascending)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1"/>
                            </svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5"/>
                            </svg>
                        }
                    </a>
                </div>

                <div class="col-md-2">
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg py-3" type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel me-2" viewBox="0 0 16 16">
                                <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z" />
                            </svg>
                            Apply
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.PaginatedProducts?.Items?.Any() != true)
    {
        <div class="text-center py-5">
            <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="#e9ecef" viewBox="0 0 16 16">
                    <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0" />
                </svg>
            </div>
            <h3 class="text-muted mb-3">No products found</h3>
            @if (!string.IsNullOrEmpty(Model.Search))
            {
                <p class="text-muted">No results for "<strong>@Model.Search</strong>"</p>
            }
        </div>
    }
    else
    {
        <!-- Products Grid -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-5" id="products-grid">
            @foreach (var product in Model.PaginatedProducts.Items)
            {
                <div class="col">
                    <div class="card h-100 product-card shadow-sm border-0">
                        <!-- Product Image -->
                        <div class="card-img-top position-relative overflow-hidden" style="height: 220px; background-color: #f8f9fa;">
                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                            {
                                <img src="@product.ImageUrl"
                                     class="w-100 h-100 object-fit-cover"
                                     alt="@product.Name"
                                     style="transition: transform 0.3s ease;"
                                     onmouseover="this.style.transform='scale(1.05)'"
                                     onmouseout="this.style.transform='scale(1)'">
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="#dee2e6" viewBox="0 0 16 16">
                                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                                    </svg>
                                </div>
                            }
                        </div>

                        <!-- Card Body -->
                        <div class="card-body d-flex flex-column">
                            <!-- Category Badge -->
                            <div class="mb-2">
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 py-2 px-3">
                                    @product.Category
                                </span>
                            </div>

                            <!-- Product Name -->
                            <h5 class="card-title fw-bold mb-2 text-dark" style="min-height: 48px;">@product.Name</h5>

                            <!-- Brand -->
                            <p class="text-muted small mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-tag me-1" viewBox="0 0 16 16">
                                    <path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0" />
                                    <path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1m0 5.586 7 7L13.586 9l-7-7H2z" />
                                </svg>
                                @product.Brand
                            </p>

                            <!-- Price -->
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="text-primary fw-bold mb-0">$@product.Price.ToString("N2")</h4>
                                            <div class="col-md-6 mb-2">
                                            @if (product.StockQuantity > 0)
                                            {
                                                <span class="text-success ms-2">In Stock (@product.StockQuantity)</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger ms-2">Out of Stock</span>
                                            }
                                            </div>
                                </div>

                                <!-- Buttons -->
                                <div class="d-grid gap-2">
                                    <a href="@Url.Action("Details", "Product", new { id = product.Id })"
                                       class="btn btn-outline-primary py-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye me-2" viewBox="0 0 16 16">
                                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z" />
                                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0" />
                                        </svg>
                                        Details
                                    </a>
                                    @if(product.StockQuantity > 0)
                                    {      
                                        <button class="btn btn-success py-2 add-to-cart-btn"
                                                onclick="addToCart(this, @product.Id,@product.StockQuantity)"
                                                data-product-id="@product.Id"
                                                data-product-name="@product.Name"
                                                data-product-price="@product.Price">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart4 me-2" viewBox="0 0 16 16">
                                                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0" />
                                            </svg>
                                            Add to Cart
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.PaginatedProducts.TotalPages > 1)
        {
            <nav aria-label="Page navigation" class="mb-5">
                <ul class="pagination justify-content-center">
                    <!-- Previous -->
                    <li class="page-item @(!Model.PaginatedProducts.HasPreviousPage ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(Model.PaginatedProducts.PageNumber - 1)" aria-label="Previous">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0" />
                            </svg>
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    @{
                        int startPage = Math.Max(1, Model.PaginatedProducts.PageNumber - 2);
                        int endPage = Math.Min(Model.PaginatedProducts.TotalPages, Model.PaginatedProducts.PageNumber + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@GetPageUrl(1)">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.PaginatedProducts.PageNumber ? "active" : "")">
                            <a class="page-link" href="@GetPageUrl(i)">@i</a>
                        </li>
                    }

                    @if (endPage < Model.PaginatedProducts.TotalPages)
                    {
                        @if (endPage < Model.PaginatedProducts.TotalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="@GetPageUrl(Model.PaginatedProducts.TotalPages)">
                                @Model.PaginatedProducts.TotalPages
                            </a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(!Model.PaginatedProducts.HasNextPage ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(Model.PaginatedProducts.PageNumber + 1)" aria-label="Next">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708" />
                            </svg>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

<style>
    /* Product card hover effect */
    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    /* Card image styling */
    .card-img-top {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }

    /* Button styling */
    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838, #1ba87e);
        transform: scale(1.02);
    }

    .btn-outline-primary {
        border-width: 2px;
        font-weight: 500;
    }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* Badge styling */
    .badge.bg-success {
        background-color: #28a745 !important;
    }

    /* Price styling */
    .text-primary {
        color: #0d6efd !important;
    }

    /* Pagination styling */
    .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .page-link {
        color: #0d6efd;
        border-radius: 8px;
        margin: 0 3px;
        padding: 8px 16px;
    }

    .page-link:hover {
        background-color: #e9ecef;
        color: #0d6efd;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .card-img-top {
            height: 180px;
        }
        
        .btn {
            padding: 0.5rem 1rem;
        }
        
        /* Adjust filter layout for mobile */
        .col-md-5, .col-md-3, .col-md-2, .col-md-auto {
            margin-bottom: 1rem;
        }
    }

    /* Accessibility */
    .btn:focus,
    .form-control:focus,
    .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        border-color: #86b7fe;
    }

    /* Skip to content for screen readers */
    .skip-to-main {
        position: absolute;
        left: -9999px;
        z-index: 999;
        padding: 1em;
        background-color: #0d6efd;
        color: white;
        text-decoration: none;
        border-radius: 4px;
    }

    .skip-to-main:focus {
        left: 50%;
        transform: translateX(-50%);
        top: 10px;
    }

    /* Sort reverse button styling */
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    /* Dropdown button styling */
    .dropdown-toggle {
        padding: 0.75rem 1rem;
        height: 100%;
    }

    /* Form controls height consistency */
    .form-select, .btn-outline-secondary, .btn-primary {
        height: 100%;
        min-height: 56px;
    }
    
      #store-dropdown ul{
          animation:none
      }

</style>
